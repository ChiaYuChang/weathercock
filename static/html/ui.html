<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Yahoo 新聞</title>
        <link rel="stylesheet" href="/css/style.css" />
        <script
            src="https://unpkg.com/htmx.org@2.0.4"
            integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
            crossorigin="anonymous"
        ></script>
        <script src="https://unpkg.com/htmx-ext-alpine-morph@2.0.0/alpine-morph.js"></script>
        <script type="module" src="/js/bundle.js"></script>
    </head>
    <body class="max-h-screen bg-slate-100">
        <div class="my-10 text-center">
            <h1 class="text-4xl font-bold text-slate-800 md:text-5xl">
                新聞搜尋
            </h1>
        </div>
        <div class="container mx-auto max-w-3xl">
            <!-- 輸入 API KEY 與 CX -->
            <section x-data="{ 'open' : true }">
                <div class="section-header" @click="open = !open">
                    <span>0.</span> 請輸入 Google API 金鑰和搜尋引擎 ID (cx)
                </div>
                <div
                    x-show="open"
                    class="px-4 py-8"
                    x-data="{
                        apikey: 'fdsfjkldsgeoaerlkj0-12oj3jlsdfigdlkalsk',
                        cx: '1234567890-123234',
                        apiKeyValid: { isValid: true, errMsg: '', errType: '' },
                        cxValid: { isValid: true, errMsg: '', errType: '' }
                    }"
                    id="api_key-cx-form"
                >
                    <div class="content-card">
                        <div class="input-container">
                            <label for="api_key" class="input-label">
                                Google API 金鑰
                            </label>
                            <input
                                type="text"
                                name="api_key"
                                id="api_key"
                                x-model="apikey"
                                :class="apiKeyValid.isValid ? '' :'border-red-500 focus:border-red-500 focus:ring-red-500' "
                                placeholder="Google API Key"
                                required
                                @input="apiKeyValid = validateApiKey(apikey)"
                                title="請於 Google Cloud Console 建立的 API 金鑰"
                            />
                            <p 
                                class="err-msg"
                                x-show="apiKeyValid.errMsg"
                                x-text="apiKeyValid.errMsg"
                            ></p>
                        </div>
                        <div class="input-container">
                            <label for="cx" class="input-label">
                                Programmable Search Engine ID (cx)
                            </label>
                            <input
                                type="text"
                                name="cx"
                                id="cx"
                                x-model="cx"
                                :class="cxValid.isValid ? '' :'border-red-500 focus:border-red-500 focus:ring-red-500' "
                                placeholder="Programmable Search Engine ID (cx)"
                                required
                                @input="cxValid = validateCx(cx)"
                                title="請於 Google Programmable Search Engine 建立的搜尋引擎 ID"
                            />
                            <p
                                class="err-msg"
                                x-show="cxValid.errMsg"
                                x-text="cxValid.errMsg"
                            ></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 輸入要比對的新聞 -->
            <section x-data='{"open": false}'>
                <div class="section-header" @click="open = !open">
                    <span>1.</span> 輸入新聞網址或內容
                </div>
                <div x-show="open" class="px-4 py-8">
                    <div
                        id="input-area"
                        x-data="{
                            mode: 'url',
                        }"
                    >
                        <div class="mb-4 flex justify-center gap-2">
                            <button
                                :class="mode === 'url' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700'"
                                class="w-1/2 rounded-l-lg px-6 py-3 text-lg font-semibold focus:outline-none"
                                @click="mode = 'url'"
                            >
                                網址
                            </button>
                            <button
                                :class="mode === 'text' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700'"
                                class="w-1/2 rounded-r-lg px-6 py-3 text-lg font-semibold focus:outline-none"
                                @click="mode = 'text'"
                            >
                                貼上文字
                            </button>
                        </div>
                        <div class="content-card">
                            <form
                                id="url-form"
                                hx-post="/api/v1/task/url"
                                hx-target="#preview-area"
                                hx-swap="innerHTML"
                                hx-push-url="/article"
                                x-show="mode === 'url'"
                                x-data='{
                                    url: "https://tw.news.yahoo.com/高齡換照年齡擬下修-73歲藍委-我是受害者-071647696.html",
                                    valid: {
                                        isValid: true,
                                        errMsg: "",
                                        errType: "",
                                        
                                    } 
                                }'
                            >
                                <div class="input-container">
                                    <label for="query_url">
                                        請輸入 Yahoo 新聞網址
                                    </label>
                                    <input
                                        type="text"
                                        name="query_url"
                                        id="query_url"
                                        x-model="url"
                                        :class="valid.errType === 'ERR_NOT_SUPPORTED_URL' ? 
                                    'border-red-500 focus:border-red-500 focus:ring-red-500' : 
                                    'border-slate-300 focus:border-indigo-500 focus:ring-indigo-500'"
                                        placeholder="tw.news.yahoo.com"
                                        required
                                        @input="valid=validateUrl(url)"
                                        title="請輸入 Yahoo 新聞網址"
                                    />
                                    <p
                                        id="query_url_err_msg"
                                        class="err-msg"
                                        x-show="valid.errMsg"
                                        x-text="valid.errMsg"
                                        x-transition
                                    ></p>
                                    <button
                                        type="submit"
                                        class="focus:ring-opacity-50 mt-3 rounded-lg bg-indigo-600 px-6 py-3 text-lg font-semibold text-white shadow-md transition duration-150 ease-in-out hover:bg-indigo-700 hover:shadow-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none md:mt-0"
                                        :disabled="!valid.isValid"
                                        :class="!valid.isValid ? 'opacity-50 cursor-not-allowed' : ''"
                                    >
                                        搜尋
                                    </button>
                                </div>
                            </form>
                            <form
                                id="query_text_form"
                                hx-post="/api/v1/task/text"
                                hx-target="#preview-area"
                                hx-swap="innerHTML"
                                hx-push-url="/article"
                                x-show="mode === 'text'"
                                x-data='{
                            content: "",
                            cleanup() {
                                this.content = "";
                                const errMsg = document.getElementById("err-msg");
                                if (errMsg) {
                                    errMsg.textContent = "";
                                }
                            },
                            valid: {
                                isValid: true,
                                errMsg: "",
                                errType: "",
                            }
                        }'
                            >
                                <div class="input-container">
                                    <textarea
                                        name="query_text"
                                        id="query_text"
                                        rows="5"
                                        x-model="content"
                                        placeholder="請輸入新聞內容或貼上文字。若有標題，請將標題放在第一行，以#開頭並與內容以空行分隔；若無標題，請直接輸入內容，系統會自動生成標題。"
                                        :class="valid.errType === 'ERR_CONTENT_LENGTH' ? 
                                    'border-red-500 focus:border-red-500 focus:ring-red-500' : 
                                    'border-slate-300 focus:border-indigo-500 focus:ring-indigo-500'"
                                        @input="valid=validateQueryText(content)"
                                        required
                                    ></textarea>
                                    <p
                                        id="query_text_err_msg"
                                        x-show="valid.errMsg"
                                        x-text="valid.errMsg"
                                        x-transition
                                        class="min-h-[1.25rem] text-sm text-red-500"
                                    ></p>
                                    <div class="flex flex-row gap-4">
                                        <button
                                            type="submit"
                                            class="focus:ring-opacity-50 basis-lg rounded-lg bg-indigo-600 px-6 py-3 text-lg font-semibold text-white shadow-md transition duration-150 ease-in-out hover:bg-indigo-700 hover:shadow-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                            :class="!valid.isValid ? 'opacity-50 cursor-not-allowed' : ''"
                                            :disabled="!valid.isValid"
                                            title="送出輸入內容"
                                        >
                                            送出
                                        </button>
                                        <button
                                            type="button"
                                            class="focus:ring-opacity-50 min-w-36 grow rounded-lg bg-indigo-600 px-6 py-3 text-lg font-semibold text-white shadow-md transition duration-150 ease-in-out hover:bg-indigo-700 hover:shadow-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                                            :class="!content ? 'opacity-50 cursor-not-allowed' : ''"
                                            :disabled="!content"
                                            title="清除輸入內容"
                                            @click="cleanup()"
                                        >
                                            清除
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 預覽新聞 -->
            <section x-data='{ "open": true }'>
                <div
                    class="my-2 cursor-pointer bg-indigo-600 px-4 py-3 text-2xl text-white"
                    @click="open = !open"
                >
                    <span>2.</span> 預覽新聞
                </div>
                <div x-show="open" class="px-4 py-8">
                    <div class="rounded-xl bg-white p-6 shadow-lg">
                        <div id="preview-area" class="px-4 py-8 text-slate-400">
                            請於上方輸入新聞網址或內容，然後點擊「搜尋」按鈕以預覽新聞。
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <footer class="mt-16 py-8 text-center text-sm text-slate-500">
            <p>&copy; 2025 新聞聚合平台. 版權所有.</p>
        </footer>
    </body>
    <script>
        document.body.addEventListener('htmx:beforeRequest', (env) => {
            const form = env.target
            // Find the closest #input-area ancestor to get Alpine data for API key and CX
            // const inputArea = form.closest('#input-area')
            // const inputAreaData = inputArea ? Alpine.$data(inputArea) : null
            const el = document.getElementById('api_key-cx-form')
            const key = el ? Alpine.$data(el) : null
            console.log('key:', key.cx, key.apikey)

            const isAPIKeyValid = validateApiKey(key.apikey)
            if (!isAPIKeyValid.isValid) {
                key.apiKeyValid = isAPIKeyValid
                console.warn('API key validation failed:', isAPIKeyValid.errMsg)
                // jump back to api_key-cx-form
                el.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                })
                env.preventDefault()
                return
            }

            const isCxValid = validateCx(key.cx)
            if (!isCxValid.isValid) {
                key.cxValid = isCxValid
                console.warn('CX validation failed:', isCxValid.errMsg)
                // jump back to api_key-cx-form
                el.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center',
                })
                env.preventDefault()
                return
            }

            if (form.id === 'url-form') {
                const url = form.querySelector('#query_url').value.trim()
                const valid = validateUrl(url)
                const alpineData = Alpine.$data(form)
                alpineData.valid = valid
                if (!valid.isValid) {
                    env.preventDefault()
                    return
                }
            }

            if (form.id === 'query_text_form') {
                console.log('Validating query_text_form')
                const content = form.querySelector('#query_text').value.trim()
                const valid = validateQueryText(content, env)
                const alpineData = Alpine.$data(form)
                alpineData.valid = valid
                if (!valid.isValid) {
                    env.preventDefault()
                    return
                }
            }
        })

        // validate query_url
        // validate query_text
        function validateQueryText(content) {
            let lb = 10
            let ub = 3000
            if (content.length < lb || content.length > ub) {
                console.warn(
                    'Content length validation failed:',
                    content.length
                )
                return {
                    isValid: false,
                    errMsg: `內容長度必須介於 ${lb} 到 ${ub} 字元之間。`,
                    errType: 'ERR_CONTENT_LENGTH',
                }
            }

            if (hasInjectionContent(content)) {
                console.warn('Potential injection content detected:', content)
                return {
                    isValid: false,
                    errMsg: '包含可疑內容，請檢查輸入。',
                    errType: 'ERR_INJECTION_DETECTED',
                }
            } else {
                return { isValid: true, errMsg: '', errType: '' }
            }
        }

        // detect if the content has potential injection content
        function hasInjectionContent(content) {
            return window.InjectionPatterns.some((pattern) => {
                pattern = new RegExp(pattern, 'i')
                return pattern.test(content)
            })
        }

        // validate url
        function validateUrl(url) {
            const urlPattern = /^(https?:\/\/)?(tw\.)?news\.yahoo\.com(\/.*)?$/i
            const reUrl = new RegExp(urlPattern, 'i')
            if (!reUrl.test(url)) {
                console.warn('Validation failed: Invalid URL format')
                return {
                    isValid: false,
                    errMsg: '請輸入有效的 Yahoo 新聞網址。',
                    errType: 'ERR_NOT_SUPPORTED_URL',
                }
            }
            return { isValid: true, errMsg: '', errType: '' }
        }

        // validate api key
        function validateApiKey(apiKey) {
            if (!apiKey) {
                console.warn('Validation failed: API key is required')
                return {
                    isValid: false,
                    errMsg: '請輸入 Google API 金鑰。',
                    errType: 'ERR_API_KEY_REQUIRED',
                }
            }

            const GoogleApiKeyPattern = /^[A-Za-z0-9-_]{39}$/
            const reApiKey = new RegExp(GoogleApiKeyPattern, 'i')
            if (!reApiKey.test(apiKey)) {
                console.warn('Validation failed: Invalid API key')
                return {
                    isValid: false,
                    errMsg: 'Google API 金鑰格式錯誤，請檢查輸入。',
                    errType: 'ERR_INVALID_API_KEY',
                }
            }
            return { isValid: true, errMsg: '', errType: '' }
        }

        // validate cx
        function validateCx(cx) {
            if (!cx) {
                console.warn(
                    'Validation failed: Programmable Search Engine ID (cx) is required'
                )
                return {
                    isValid: false,
                    errMsg: 'Programmable Search Engine ID (cx) 為必填項目。',
                    errType: 'ERR_CX_REQUIRED',
                }
            }

            const cxPattern = /^[A-Za-z0-9-_]{17}$/
            const reCx = new RegExp(cxPattern, 'i')
            if (!reCx.test(cx)) {
                console.warn(
                    'Validation failed: Invalid Programmable Search Engine ID (cx)'
                )
                return {
                    isValid: false,
                    errMsg: 'Programmable Search Engine ID (cx) 格式錯誤，請檢查輸入。',
                    errType: 'ERR_INVALID_CX',
                }
            }
            return { isValid: true, errMsg: '', errType: '' }
        }

        // fetch keywords from /api/v1/keywords
        // Alpine.js compatible async function to fetch keywords from backend
        async function pollKeywords(interval = 500) {
            let result
            while (true) {
                result = await keywords()
                if (result.is_ready) {
                    break
                }
                await new Promise((resolve) => setTimeout(resolve, interval))
                interval = Math.min(interval * 2, 10000) // Exponential backoff, max 10 seconds
            }
            return result
        }

        async function keywords() {
            const controller = new AbortController()
            const timeoutId = setTimeout(() => controller.abort(), 5000)
            try {
                const response = await fetch('/api/v1/keywords', {
                    method: 'GET',
                    signal: controller.signal,
                })
                clearTimeout(timeoutId)
                if (response.status === 200) {
                    return await response.json()
                } else if (response.status === 503) {
                    return {
                        is_ready: false,
                        keywords: [],
                        message: '仍在處理中，請稍後再試。',
                    }
                } else {
                    throw new Error('Server error')
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    return {
                        is_ready: false,
                        keywords: [],
                        message: '請求超時，請稍後再試。',
                    }
                } else {
                    return {
                        is_ready: false,
                        keywords: [],
                        message: '發生未預期錯誤，請稍後再試。',
                    }
                }
            }
        }
    </script>
</html>
