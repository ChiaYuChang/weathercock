# Weathercock: 媒體識讀與政治透明化平台

協助使用者快速、系統性地比較台灣主流媒體對於同一事件的報導，並與主要政黨發布的新聞稿進行語意與立場分析。透過嵌入式語意比對與可視化介面，

本系統幫助使用者：
1. 減少資訊迷霧
2. 辨識媒體或政黨偏見
3. 提高新聞素養與判斷能力

## ✨ 功能與特色

多元輸入方式: 支援使用者透過貼上 Yahoo 新聞網址（`tw.news.yahoo.com/...`）或直接輸入新聞全文進行分析。
*   **非同步任務處理**：採用訊息驅動架構，使用者提交任務後可立即獲得回應，後端透過一系列微服務進行分析，前端即時更新進度與結果。
*   **智慧內容比對**：綜合使用**嵌入向量餘弦相似度 (Cosine Similarity)** 與 **大型語言模型 (LLM)** 進行關聯性判斷，提供精準的內容比對分數。
*   **統一資料來源**：每日自動爬取並整合各政黨新聞稿，與使用者提供的新聞內容一同存入資料庫，作為分析比對的基礎。
*   **現代化前端互動**：運用 Alpine.js 與 HTMX 技術，打造非同步提交、即時驗證與無刷新更新的流暢使用者體驗。

## ⚙️ 系統架構與資料流

本系統採用以 Go 開發的微服務架構，服務之間透過 NATS JetStream 訊息佇列進行通訊，確保系統的水平擴展性與容錯能力。

**完整處理流程如下：**

1.  **任務啟動**：
    1. 使用者在前端提交新聞網址或內容。
    2. 後端 API 接收請求，在 PostgreSQL 資料庫中建立一筆 `task` 紀錄，並立即返回 `task_id`。
    3. 依據使用者提交的內容選擇爬取內容或者直接寫入資料庫
        - 使用者輸入為 Yahoo 新聞的 URL 時，發布一則 `task.scrape` 事件至 NATS，訊息中包含 `task_id` 與 `url`。
        - 使用者輸入為文章時，發布一則 `task.generate_title` 事件至 NATS，訊息中包含 `task_id` 與 `content`。
    4. 前端頁面轉至結果頁，並根據 `task_id` 定期輪詢後端 API 以獲取最新進度。

2.  **內容爬取與處理 (Scraper Worker)**：
    1. 爬蟲服務監聽 `task.scrape` 事件。
    2. 接收到任務後，爬取 Yahoo 新聞頁面內容，並將其標準化後存入 `public.articles` 表。
    3. 完成後發布 `task.extract.keyword` 事件，抽取文章中關鍵字。

3. **自動產生標題 (Title Generator)**
    1. 標題產服務監聽 `task_generate_title` 事件。
    2. 總結訊息中的 `content`
    3. 更新`user.articles` 表內容

3.  **AI 分析 (Analysis Workers)**：
    *   **關鍵字提取**：監聽 `task.extract.keyword` 事件，使用 LLM 從暫存的內文中提取關鍵字，並寫入 Valkey。
    *   **嵌入向量生成**：對文章內容進行切塊 (Chunking)，並為每個區塊生成 Embedding 向量。
    *   **關聯內容搜尋**：根據關鍵字與向量，從資料庫中搜尋相關的既有新聞與政黨新聞稿。

4.  **結果呈現**：
    *   前端透過輪詢 `api/article/{task_id}` 和 `api/keywords/{task_id}` 等端點，逐步向使用者展示已完成的分析結果。

## 🛠️ 技術棧

| 類別         | 技術                                       |
| ------------ | ------------------------------------------ |
| **後端**       | Go                                         |
| **前端**       | HTMX, Alpine.js                            |
| **資料庫**     | PostgreSQL                                 |
| **快取**       | Valkey (Redis Fork)                        |
| **訊息佇列**   | NATS JetStream                             |
| **AI/ML**    | 大型語言模型 (LLM), 嵌入向量 (Embeddings) |

## 🚀 架構改進建議

為進一步提升系統的穩健性、效率與擴展性，茲建議如下：

| 領域         | 建議                                                                                                                                                                                          |
| ------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **韌性與容錯** | 在所有 NATS Worker 中導入明確的錯誤處理與重試機制（如 NATS 延遲重發），以應對外部服務（如 LLM API、網站爬取）的暫時性故障。                                                                      |
| **狀態管理**   | 將任務的關鍵狀態（如 `scraped`, `keyword_extracted`）與核心的中間產物（如新聞內文、關鍵字）持久化至 PostgreSQL，確保在快取服務失效時，任務仍能從上一個成功節點恢復。                         |
| **NATS 訊息流** | 1. **主題命名**：採用事件驅動式命名（如 `task.created`, `article.scraped`），使系統更具擴展性。<br>2. **訊息內容**：在訊息中攜帶執行下一步驟所需的最小上下文，以減少 Worker 對資料庫的重複查詢，降低服務耦合。 |
| **NATS JetStream** | 為每個 Worker 設定持久化消費者 (Durable Consumer)，並嚴格執行 `Ack` 確認機制，確保即使 Worker 短暫離線重啟，也不會遺漏任何訊息。                                                              |
| **使用者互動** | 建立明確的 API 流程，當使用者在前端修改關鍵字時，應能觸發新的 NATS 事件，以更新後的關鍵字重新執行搜尋與比對。                                                                                  |